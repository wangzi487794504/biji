#### 对象锁

* **局部变量是否线程安全？** 

  - 局部变量是线程安全的 
  - 但局部变量引用的对象则未必 

  - - 如果该对象没有逃离方法的作用访问，它是线程安全的 

    - 如果该对象逃离方法的作用范围，需要考虑线程安全

      ```java
      public static void test1() {
          int i = 10;
          i++; 
      }
      ```

      * 每个线程调用 test1() 方法时局部变量 i，会在每个线程的栈帧内存中被创建多份，因此不存在共享
      * ==私有方法可以保护线程安全，因为子类不能覆盖它==

  * 常见的线程安全
    * String 
    * Integer 
    * StringBuffer 
    * Random 
    * Vector 
    * Hashtable 
    * java.util.concurrent 包下的类
    * 这里说它们是线程安全的是指，多个线程调用它们同一个实例的某个方法时，是线程安全的。也可以理解为它们的每个方法是原子的 。但注意它们多个方法的组合不是原子的。**因为方法**之间可能发生cpu切换
  * String、Integer 等都是不可变类，因为其内部的状态不可以改变，因此它们的方法都是线程安全的 



* 对象头

  * 以 32 位虚拟机为例

    * 普通对象

      ![1722233002568](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722233002568.png)

      * Mark Word 主要用来存储对象自身的运行时数据
      * Klass Word 指向Class对象

    * 数组对象

      ![1722233084523](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722233084523.png)

    * markWord

      ![1722233118216](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722233118216.png)





* ### Monitor 结构

  * **每一个java对象都可以关联一个monitor对象**

    ![1722233519046](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722233519046.png)
    
  * 每个 Java 对象都可以关联一个 Monitor 对象==（它是操作系统提供的）==，如果使用 synchronized 给对象上锁（重量级）之后，该对象头的Mark Word 中就被设置指向 Monitor 对象的指针
  
  * 具体流程
  
    * 刚开始 Monitor 中 Owner 为 null 
    * 当 Thread-2 执行 synchronized(obj) 就会将 Monitor 的所有者 Owner 置为 Thread-2，Monitor中只能有一个 Owner 
    * 在 Thread-2 上锁的过程中，如果 Thread-3，Thread-4，Thread-5 也来执行 synchronized(obj)，就会进入EntryList BLOCKED 
    * ==Thread-2 执行完同步代码块的内容，然后唤醒 EntryList 中等待的线程来竞争锁，竞争的时是非公平的 ==
    * 图中 WaitSet 中的 Thread-0，Thread-1 是之前获得过锁，但条件不满足进入 WAITING 状态的线程，后面讲wait-notify 时会分析



* 轻量级锁

  * 如果一个对象虽然有多线程要加锁，但加锁的时间是错开的（也就是没有竞争），那么可以使用轻量级锁来优化。 

  * 如果一个对象虽然有多线程要加锁，但加锁的时间是错开的（也就是没有竞争），那么可以使用轻量级锁来优化。 

  * 流程

    * 创建 锁记录（Lock Record）对象，每个线程的栈帧都会包含一个锁记录的结构，内部可以存储锁定对象的Mark Word 

      <img src="%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722238826282.png" alt="1722238826282" style="zoom:80%;" />

    * 让锁记录中 Object reference 指向锁对象，并尝试用 cas` 替换 （是替换）`Object 的 Mark Word，将 Mark Word 的值存入锁记录

      <img src="%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722238893069.png" alt="1722238893069" style="zoom:67%;" />

    * 如果 cas 替换成功，对象头中存储了 `锁记录地址和状态 00 `，表示由该线程给对象加锁，这时图示如下

      <img src="%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722238945144.png" alt="1722238945144" style="zoom:67%;" />

    * 如果 cas 失败，有两种情况 

    - - 如果是其它线程已经持有了该 Object 的轻量级锁，这时表明有竞争，进入锁膨胀过程 

      - 如果是自己执行了 synchronized 锁重入，那么再添加一条 Lock Record 作为重入的计数==（先增加一条锁记录）==

        

        <img src="%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722238992450.png" alt="1722238992450" style="zoom:67%;" />

      - 当退出 synchronized 代码块（解锁时）如果有取值为 null 的锁记录，表示有重入，这时重置锁记录，表示重入计数减一

        <img src="%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722242060306.png" alt="1722242060306" style="zoom:67%;" />

* (轻量级)锁膨胀(为重量级锁) 

  * 如果在尝试加轻量级锁的过程中，CAS 操作无法成功，这时一种情况就是有其它线程为此对象加上了轻量级锁（有竞争），这时需要进行锁膨胀，将轻量级锁变为重量级锁。

  * 当 Thread-1 进行轻量级加锁时，Thread-0 已经对该对象加了轻量级锁

    ![1722242257717](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722242257717.png)

  * 这时 Thread-1 加轻量级锁失败，进入锁膨胀流程 

  - - 即为 Object 对象申请 Monitor 锁，让 Object 指向重量级锁地址 

    - 然后自己进入 Monitor 的 EntryList BLOCKED

      ![1722242291756](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722242291756.png)

  - 当 Thread-0 退出同步块解锁时，使用 cas 将 Mark Word 的值恢复给对象头，失败。这时会进入重量级解锁流程，即按照 Monitor 地址找到 Monitor 对象，设置 Owner 为 null，唤醒 EntryList 中 BLOCKED 线程

* 自旋锁

  * 重量级锁竞争的时候，还可以使用自旋(循环尝试获取重量级锁)来进行优化，如果当前线程自旋成功（即这时候持锁线程已经退出了同步块，释放了锁），这时当前线程就可以避免阻塞。 (进入阻塞再恢复,会发生上下文切换,比较耗费性能)

  * 自旋成功的情况

    ![1722242686654](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722242686654.png)

  * 自旋失败的情况

    ![1722242713374](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722242713374.png)

  * 自旋会占用 CPU 时间，单核 CPU 自旋就是浪费，多核 CPU 自旋才能发挥优势。 

  * 在 Java 6 之后自旋锁是自适应的，比如对象刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能性会高，就多自旋几次；反之，就少自旋甚至不自旋，总之，比较智能。 

  * Java 7 之后不能控制是否开启自旋功能



* (比轻量级锁更轻的)偏向锁

  * ==轻量级锁在没有竞争时（就自己这个线程），每次重入仍然需要执行 CAS 操作。==

  * Java 6 中引入了偏向锁来做进一步优化：只有第一次使用 CAS 将线程 ID 设置到对象的 Mark Word 头，之后发现这个线程 ID 是自己的就表示没有竞争，不用重新 CAS。以后只要不发生竞争，这个对象就归该线程所有 

  * 处于偏向锁的对象解锁后，线程 id 仍存储于对象头中。也就是偏(心)向某个线程了

  * 测试 hashCode ，在`Dog d = new Dog();`后加上一句 `d.hashCode();`

    - 正常状态对象一开始是没有 hashCode 的，第一次调用才生成

    - 调用了 hashCode() 后会撤销该对象的偏向锁。因为对象头已经没有空间存储hashcode

      ![1722244326805](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722244326805.png)**

  * 批量重偏向

    * 如果对象虽然被多个线程访问，但没有竞争，这时偏向了线程T1的对象仍有机会重新偏向T2，重偏向会重置对象的Thread ID 

    * 当撤销偏向锁阈值超过20次后（前20之前都是轻量级锁），jvm会这样觉得，我是不是偏向错了呢，于是会在给这些对象加锁时重新偏向至加锁线程。

      ```java
      private static void test3() throws InterruptedException {
          
          Vector<Dog> list = new Vector<>();
          //list此时会偏向t1
          Thread t1 = new Thread(() -> {
              for (int i = 0; i < 30; i++) {
                  Dog d = new Dog();
                  list.add(d);
                  synchronized (d) {
                      log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintableSimple(true));
                  }
              }
              synchronized (list) {
                  list.notify();
              }
          }, "t1");
          t1.start();
          //这时候会切换轻量级锁
          Thread t2 = new Thread(() -> {
              synchronized (list) {
                  try {
                      list.wait();
                  } catch (InterruptedException e) {
                      e.printStackTrace();
                  }
              }
              log.debug("===============> ");
              for (int i = 0; i < 30; i++) {
                  Dog d = list.get(i);
                  log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintableSimple(true));
                  synchronized (d) {
                      log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintableSimple(true));
                  }
                  log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintableSimple(true));
              }
          }, "t2");
          t2.start();
      }
      [t1] - 0 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 1 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 2 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 3 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 4 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 5 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 6 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 7 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 8 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 9 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 10 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 11 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 12 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 13 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 14 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 15 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 16 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 17 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 18 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t1] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - ===============> 
      [t2] - 0 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 0 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 1 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 1 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 1 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 2 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 2 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 2 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 3 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 3 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 3 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 4 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 4 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 4 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 5 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 5 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 5 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 6 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 6 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 6 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 7 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
      [t2] - 7 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 7 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 8 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 8 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 8 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 9 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 9 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 9 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 10 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 10 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 10 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 11 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 11 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 11 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 12 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 12 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 12 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 13 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 13 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 13 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 14 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 14 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 14 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 15 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 15 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 15 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 16 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 16 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 16 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 17 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 17 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 17 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 18 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 18 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000 
      [t2] - 18 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001 
      [t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
      [t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101 
      [t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101 
      [t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
      ```

  * 批量撤销

    * 当撤销偏向锁阈值超过 40 次后，jvm 会这样觉得，自己确实偏向错了，根本就不该偏向。于是整个类的所有对象都会变为不可偏向的，新建的该类型对象也是不可偏向的 

  * 锁消除

    * 锁消除      JIT即时编译器会对字节码做进一步优化

      ```java
      
      @Fork(1)
      @BenchmarkMode(Mode.AverageTime)
      @Warmup(iterations=3)
      @Measurement(iterations=5)
      @OutputTimeUnit(TimeUnit.NANOSECONDS)
      public class MyBenchmark {
          static int x = 0;
          @Benchmark
          public void a() throws Exception {
              x++;
          }
          @Benchmark
          public void b() throws Exception {
              //这里的o是局部变量,不会被共享,JIT做热点代码优化时会做锁消除
              Object o = new Object();
              synchronized (o) {
                  x++;
              }
          }
      }
      ```

      ![1722256418206](%E5%AF%B9%E8%B1%A1%E9%94%81.assets/1722256418206.png)