# Integrating Diagnosis Rules into Deep Neural Networks for Bladder Cancer Staging 

<p align="right">将诊断规则集成到深度神经网络中用于膀胱癌分期</p>
**摘要：**膀胱癌是一种恶性疾病，具有很高的发病率和死亡率。膀胱癌分期对于确定临床上膀胱肿瘤的有效治疗至关重要。由于特征学习的优越性，深度卷积神经网络 (DCNN) 被广泛用于基于医学图像的癌症分期预测。但是，==大多数现有的基于DCNN的癌症分期方法都是数据驱动的，并且忽略了临床医生的领域知识和经验==。==此外，深度神经网络缺乏模型可解释性，可能导致风险诊断。==为了解决这些问题，我们根据肿瘤渗透到膀胱壁的临床经验，构建了膀胱癌分期的诊断规则。从磁共振 (MR) 图像中提取诊断规则，并进一步集成到DCNN中，以联合识别肿瘤分期。实验验证了集成规则提高了模型的可解释性，并指导DCNN专注于肿瘤渗透区域，从而产生癌症分期的精确预测。

## 介绍

膀胱癌是最常见的恶性疾病之一，死亡率高，复发率高 [1]。在临床诊断中，膀胱癌分期是根据医学图像进行的，以确定治疗方法。人类医生通常通过测量肿瘤渗入膀胱壁的程度来估计膀胱癌的阶段。根据穿透程度，膀胱肿瘤可以从T0分期到T4分期，T2或更高的肿瘤通常通过部分或全部膀胱切除术治疗 [13]。因此，确定膀胱肿瘤的分期是否超过T2，对于制定有效的治疗计划和预测膀胱癌的预后至关重要。

由于特征学习的优越性，深度卷积神经网络 (DCNN) 已广泛应用于膀胱癌的计算机辅助诊断，包括膀胱分割 [3,11]，膀胱癌检测 [4,14] 和分期 [6,7]。对于癌症分期，现有的基于DCNN的方法通过从医学图像中提取非语义特征，直接将肿瘤分级。但是，这些数据驱动的方法忽略了临床医生的领域知识和经验，这在临床诊断中很重要。此外，由于模型可解释性的不足，很难理解由深度神经网络产生的肿瘤分期结果，这可能导致膀胱癌临床诊断的混乱。

为了解决这些问题，我们提出了一种新颖的膀胱癌分期方法，其中将临床经验的诊断规则整合到深度卷积神经网络中，以识别肿瘤的分期。所提出方法的工作流程如图1所示。首先，我们根据肿瘤渗透的临床经验构建膀胱癌分期的诊断规则，并实施神经网络来生成诊断规则。其次，我们将诊断规则的神经网络与深度卷积神经网络集成在一起，以识别磁共振 (MR) 图像中的膀胱肿瘤阶段。论文工作的贡献总结如下:

* 实施神经网络，根据临床经验生成膀胱癌分期的逻辑规则。我们从MR图像中提取肿瘤和膀胱壁之间距离的语义特征作为网络的输入，其中距离的参数在逻辑上连接以形成逻辑诊断规则。通过软逻辑 [2] 放松逻辑操作，以方便模型优化。
* 将诊断规则的神经网络和深度卷积神经网络相结合，对癌症分期进行联合识别。联合模型的目标包括基于图像的预测和规则约束的预测。受诊断规则的约束，深度卷积神经网络将专注于肿瘤渗透区域，从而提高癌症分期的预测和模型的可解释性。

## 框架

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668235819370.png" alt="1668235819370" style="zoom:80%;" />

## 将诊断规则与深度神经网络集成用于癌症分期

### 3.1诊断规则生成

根据临床经验，膀胱癌分期与肿瘤侵入膀胱壁的程度有关。因此，可以根据肿瘤穿透事件来实施癌症分期的诊断规则。**我们将水平方向的肿瘤穿透事件定义为𝐴~ℎ~ = {𝐴^+^ ~ℎ~/𝑚^+^ ~ℎ~, 𝐴^−^ ~ℎ~ /𝑚^−^ ~ℎ~ }，其中𝐴^+^ ~ℎ~, 𝐴^−^ ~ℎ~ 表示穿透是否发生，𝑚^+^ ~ℎ~, 𝑚^−^ ~h~ 是事件的概率。**类似地，垂直方向的肿瘤穿透事件 ℎ 定义为𝐴~𝑣~ = {𝐴+𝑣 /𝑚+𝑣 ，𝐴− 𝑣 /𝑚− 𝑣 }。通过肿瘤穿透事件，我们可以构建以下癌症分期规则，注释

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668236808572.png" alt="1668236808572" style="zoom:80%;" />

规则包含了神经网络中不连续且难以优化的逻辑算子，因此我们通过软计算 [2] 将逻辑算子近似为

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668236858320.png" alt="1668236858320" style="zoom:80%;" />

考虑事件的概率，我们有

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668236994549.png" alt="1668236994549" style="zoom:80%;" />

其中 𝑚^+^，𝑚^−^ 是 𝑠𝑡𝑎𝑔e≥𝑇 2和 𝑠𝑡𝑎𝑔𝑒 &lt; 𝑇 2的概率。

为了从mr图像中提取癌症分期规则，我们构建了一个神经网络，该网络由输入层，激活层和规则层组成，如图1所示。基于膀胱分割，==我们计算水平和垂直方向上膀胱壁与肿瘤之间的距离，以测量作为模型输入的穿透程度。==图2显示了垂直距离计算的示例。对于 𝑊 × 𝐻 图像中的一列，我们定位膀胱壁 (用蓝点标记) 和肿瘤 (用黄点标记) 的最外像素，并以 𝐼𝑤 _min，𝐼𝑤 _max，𝐼𝑡 _min，𝐼𝑡 _max表示像素的索引。第 𝑖 列的垂直距离计算为

<p align='center'>𝑑𝑖 = max{𝐼𝑤_ min − 𝐼𝑡_ min, 𝐼𝑡_ max − 𝐼𝑤_ max}.</p>
计算每列中的距离，我们通过 𝑑𝑣 = max{𝑑 1，...，𝑑𝑊} 获得垂直方向上的距离。以类似的方式，我们可以获得水平方向上的距离 𝑑。可以观察到，如果 𝑑𝑣&gt; 0或 𝑑~ℎ~> 0，则肿瘤穿透膀胱壁。

通过激活层，距离 𝑑𝑣 和 𝑑 ℎ，映射到 [-1,1] 范围内的值 𝑔𝑣，𝑔 ℎ，并传递到规则层。在规则层中，根据公式 (3,4)，我们构造了两个表示 𝐴~ℎ~ 和 𝐴~𝑣~ 的模块，每个模块包含两个神经元，以输出 𝑠𝑡𝑎𝑔≥ 𝑇 2和 𝑠𝑡𝑔 &lt;𝑇 2的概率。假设神经元 𝐴^+^ ~ℎ~，𝐴 ^−^ ~ℎ~ 的输出为 (𝑚^+^ ~ℎ~，𝑚 ^−^ ~ℎ~)，𝐴^+^ ~𝑣~，𝐴^−^ ~v~ 的输出为 (𝑚^+^ ~𝑣~m^-^ ~h~ ), 我们采用 softmax 函数将概率输出表示为 

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668240400278.png" alt="1668240400278" style="zoom:80%;" />

假设基于规则的癌症分期预测为 𝒎 = (𝑚 −，𝑚+)，𝑠𝑡𝑎𝑔≥ 𝑇 2的基本真实值为 𝒚 = (0,1)，𝑠𝑡𝑎𝑔𝑒 &lt;𝑇 2为 𝒚 = (1,0)，用于生成诊断规则的神经网络通过最小化定义为

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668240549484.png" alt="1668240549484" style="zoom:80%;" />

其中 𝑁 为医学图像的数量。

### 2.2将诊断规则集成到深度卷积神经网络中

为了将生成的诊断规则集成到DCNN中进行癌症分期预测，我们构建了基于图像的预测和规则约束预测的联合损失目标。假设 𝒚~𝑛~ 是第 𝑛 个图像 𝒙~𝑛~ 的地面真实，𝑓(𝒙~𝑛~) 是DCNN仅依赖于图像输出的预测，𝒒~𝑛~ 是有诊断规则约束的DCNN的预测，联合损失定义为

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668241080930.png" alt="1668241080930" style="zoom:80%;" />

 其中H(·,·)是衡量两个预测之间差异的交叉熵，𝛼是平衡基于图像的预测和规则约束预测的损失的因素。我们将𝛼 = 0.4 设置为默认值。 

接下来我们制定规则约束预测 𝒒~𝑛~。基于图像的DCNN定义了预测的概率分布 𝑝𝜃 (𝒚 | 𝒙)，由 𝜃 参数化。在诊断规则的约束下，DCNN的预测概率分布为 𝑞(𝒚 | 𝒙)。最优 𝑞(𝒚 | 𝒙) 应符合 𝑝𝜃 (𝒚 | 𝒙)，同时与诊断规则诱导的预测保持一致。假设诊断规则的预测函数为: ℎ ℎ (𝒚 | 𝒙)，𝜑 表示规则网络的参数，我们采用期望 𝐸~𝑞(𝒚|𝒙)~ [ℎ(𝒚 | 𝒙) ] 来衡量 𝑞 (𝒚 | 𝒙) 与规则预测的一致性。当期望接近1时，𝑞 与规则一致。利用KL散度来衡量 𝑞(𝒚 | 𝒙) 和 𝑝𝜃 (𝒚 | 𝒙) 之间的差异，我们将规则约束预测的优化目标构造为



<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668242074504.png" alt="1668242074504" style="zoom:80%;" />

其中，𝜉 是规则约束的松弛变量，𝜆 是规则的置信度，𝐶 是正则化参数。参考 [5,9]，可以以对偶形式求解目标函数 (12)，并且我们可以获得解。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668242123516.png" alt="1668242123516" style="zoom:80%;" />

借助规则约束预测的最优概率分布，我们可以生成 𝒒𝑛、𝑛 = 1、2...、𝑁 并计算 DCNN 训练的联合损失。在模型训练的工作流程中，对基于规则的网络和 DCNN 进行了迭代优化。在每次迭代中，我们首先通过最小化（10）来优化基于规则的网络，然后根据（13）构造𝑞（𝒚|𝒙）。基于𝑞（𝒚|𝒙），我们计算联合损失并通过最小化（11）来优化 DCNN 的参数。

## 实验结果

我们对从中国大学计算机设计竞赛中收集的膀胱癌数据集进行了实验，其中包含来自25名患者的478张MR图像，以验证所提出的膀胱癌分期方法的有效性。图像的大小是512 × 512。我们按患者划分数据集，并实施交叉验证。准确性，精确度，召回率和F1评分的度量用于评估癌症分期的预测结果。我们确保不同阶段的样本在数据集上是平衡的**。ResNet18 [8] 被视为我们方法中采用的DCNN的主干**。为了全面评估所提出方法的性能，我们将所提出的方法与由优雅的DCNN模型和典型分类算法诱导的癌症分期方法进行了比较。比较的DCNN模型包括DenseNet [10] 和ResNet18 [8]。分类算法包括支持向量机 (SVM)，逻辑回归和多层感知器 (MLP) [12]，并且基于 [6] 中提出的放射组学特征实现了mr图像的分类。实验结果如图3所示：

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1668244063210.png" alt="1668244063210" style="zoom:80%;" />

可以观察到，所提出的方法达到了最佳性能。由于医学图像特征提取的优越性，DCNN模型比SVM、MLP和具有Radiomics特征的逻辑回归等分类方法实现了更精确的癌症分期预测。通过整合肿瘤穿透的诊断规则，ResNet18诱导的肿瘤分类的准确率、准确率、召回率和F1分数分别提高了3.06%、2.88%、1.17%和3.63%。相信该诊断规则有助于改进基于DCNN的癌症分期预测。为了进一步验证这一改进，我们利用 CAM [15] 来可视化 MR 图像中的感兴趣区域 (ROI)，这对用于膀胱癌分期的卷积神经网络有很大影响。

图 4 展示了 ResNet18 和我们的方法获得的 ROI 热图。可以观察到，在规则的约束下，我们方法中神经网络的特征学习更多地集中在肿瘤和膀胱壁之间的穿透区域（热图中用红色表示），这与临床经验相吻合。表明通过诊断规则的整合，领域经验有效地参与了深度卷积神经网络的医学图像分类，从而提高了癌症分期的预测。此外，通过规则生成的神经网络，我们还可以从MR图像中获得可解释的诊断规则，这有助于处理令人困惑的病例，并支持临床医生了解神经网络输出的癌症分期结果。图 5 显示了膀胱癌 MR 图像，这些图像被 ResNet18 错误分类，但我们的方法根据诊断规则正确分期。图 5(a) 呈现了𝑠𝑡𝑎𝑔𝑒 < 𝑇2 的情况，因为肿瘤非常靠近薄的膀胱壁，仅基于图像的 DCNN 会被混淆，从而产生高癌症分期的决策错误。相比之下，从图像中提取的规则表明没有肿瘤穿透，并指导神经网络实现正确的癌症阶段预测。在图 5(b) 中，肿瘤和膀胱壁的强度相似，这会误导 DCNN 产生对癌症分期的错误预测。在诊断规则的指导下，我们方法中的网络捕获了肿瘤穿透的特征并产生了正确的预测。

## 结论

现有的DCNN膀胱癌分期方法是数据分析的，缺乏临床经验和可解释性。在本文中，我们提出了一种膀胱癌分期方法，其中将临床经验编码为逻辑诊断规则，并将其集成到DCNN中，以提高对癌症分期的预测。实验结果验证了该方法的有效性。神经网络中域经验的表示形式和逻辑规则的权重将在以后的工作中进行研究。