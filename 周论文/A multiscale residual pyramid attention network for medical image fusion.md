# A multiscale residual pyramid attention network for medical image fusion

用于医学图像融合的多尺度残余金字塔注意网络

**摘要：**近年来，深度学习在成像领域得到了广泛的应用。残差，金字塔和注意力网络相继提出，并因其出色的性能而被广泛使用。然而，单个网络的性能是有限的。基于此，我们提出了一种用于医学图像融合的多尺度残余金字塔注意网络 (MSRPAN)。我们的网络由一个特征提取器，定影器和重构器组成。**特征提取器由三个MSRPAN块组成，用于提取多尺度特征。**重建器由三个卷积层组成，用于重建融合的特征。此外，我们提出了特征融合过程的特征能量比策略。所提出的策略在实验中取得了更好的融合效果。与现有的最新算法相比，我们的算法在视觉质量和客观指标方面取得了更好的性能。

多模态医学图像可以通过不同种类的现代医疗设备获得。磁共振成像 (MRI) 具有高分辨率和丰富的软组织信息。计算机断层扫描 (CT) 图像可以清楚地显示骨骼和高密度组织信息。正电子发射断层扫描 (PET) 和单光子发射计算机断层扫描 (SPECT) 图像显示了组织和细胞的活动，可为许多疾病的早期诊断提供参考。多模态医学图像显示了人体中不同的组织或疾病信息。如果医生通过识别大量原始医学图像来诊断疾病状况，将浪费相当多的时间，并且需要丰富的经验。将原始多模态图像中的不同和互补信息融合到一个图像中，可以帮助医生更好地分析不易观察的疾病，减少误诊和手术错误。

由于图像融合的巨大应用价值，已经提出了许多融合算法。**多尺度变换 (MST) 是一种经典的图像融合算法。首先，通过MST将原始图像分解为多尺度层。然后使用不同的规则来融合多尺度层。最后，可以通过多尺度逆变换获得融合图像。**该方法很好地利用了多尺度信息和特征，可以灵活地利用不同的融合规则获得融合图像。常用的MST融合算法包括小波 [1-3]，金字塔 [4,5]，非下采样Shearlet变换 (NSST) [6,7]，非下采样Contourlet变换 (NSCT) [8-10] 等。金字塔，NSST和NSCT能够将图像分解为多个方向的子带，并同时捕获轮廓信息。但这些算法都是基于多尺度变换原理，需要很多分解操作，分解层数不易确定。稀疏表示 (SR) 也是一种常见的图像融合算法。它通过优化过度完整的字典和稀疏系数来实现图像融合。SR具有节省存储空间，运行速度快，适应性好等优点。在 [11] 中提出了一种用于医学图像融合的自适应稀疏表示算法。该算法改进了传统的稀疏表示算法，增加了适应性，同时也增加了计算量。Liu等人 [12] 提出了一种基于MST和SR的图像融合方法，该方法具有多尺度特征表示和广泛适应性的优点。然而，它的计算和复杂度高于基于MST或SR的单一算法。

脉冲耦合神经网络 (pcnn) 具有与人类视觉系统类似的处理复杂信息的能力。它可以从图像中提取有效的特征，而无需学习或训练。基于MST和PCNN的融合方法可以有效地结合PCNN的多尺度特征和优势进行信息提取。Yin等 [13] 提出了一种基于NSST和PCNN的融合方法。该方法以增加的计算和复杂性为代价实现了更好的融合结果，并且需要调整大量参数。此外，还有许多基于其他理论的融合算法，例如形态成分分析 [14]，自适应云模型 [15] 等。尽管基于形态分量分析和基于自适应云模型的算法在一定程度上提高了融合质量，但由于复杂的数学原理，它们需要更多的计算和参数。因此，这些因素降低了融合算法的效率。

随着深度学习 (DL) 的快速发展，近年来提出了大量基于DL的图像融合算法。在 [16] 中提出了一种用于多曝光图像的无监督深度融合算法，称为DeepFuse。DeepFuse显著提高了融合效率。尽管如此，它仅适用于多曝光图像融合。Liu等 [17] 提出了一种基于卷积神经网络的多焦点图像融合算法。尽管该方法取得了更好的融合效果和更广泛的应用，但卷积神经网络仅用于提取融合过程中使用的权重图。因此，该算法本质上仍然是一种传统算法。由于其完美的复杂拟合能力，自动学习和多任务适应性，DL在医学领域具有巨大的潜力，例如在分期模型 [18]，疾病检测 [19,20]，病变分割 [21-26] 和疾病分类 [27-30]。

但是，基于MST的分解级别不容易确定。因此，它的适应性不是很好。基于SR模型的算法过于依赖于过完备字典的建立质量和稀疏系数的优化。因此，字典重构效果和优化算法将直接影响融合结果。基于PCNN的融合算法需要调整大量的参数，增加了复杂度。其他基于特定理论的融合算法很复杂，应用范围也不广。基于DL的图像融合算法具有结构简单、易于实现、适应性广等优点。

在本文中，我们提出了一种新的基于多尺度残余金字塔注意网络 (MSRPAN) 的医学图像融合算法，该算法如图1所示。如果原始图像是PET或SPECT模态，则将其转换为YCbCr数据，包括Y1，Cb和Cr。MRI (或CT) 图像是灰度，我们将其表示为Y2 (或表示为Y1)。然后，我们将Y1和Y2放入我们的网络中，最后可以生成融合的数据Y。如果原始数据包括PET或SPECT图像，则我们将Y，Cb和Cr数据转换为RGB通道，然后获得融合图像。当网络的训练过程完成后，融合过程将自动运行，无需额外的参数调整。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1666948525250.png" alt="1666948525250" style="zoom:50%;" />

本文的贡献如下所示。 

* (1) 提出了一种新的网络结构MSRPAN，用于医学图像融合。 
* (2)提出了基于特征能量比的融合策略，取得了较好的融合效果。
*  (3) 我们提出的算法比比较算法具有更好的融合质量。我们的融合图像的视觉质量和大多数指标都优于参考算法。

本文的其余部分安排如下。在第二节中，我们简要介绍了相关工作。第3节介绍了我们提出的算法的原理和结构。在第4节中，给出了实验过程和结果，并将我们的算法与参考方法进行了比较。第五节对本文进行了总结。

### 二.相关工作

为准备以下内容，本部分主要介绍了相关工作，包括剩余注意力和金字塔注意力的机制和结构。然后，介绍我们的网络。

#### 2.1残差注意力机制

自从残差网络 [31,32] 被提出以来，许多研究都基于它。随着传统网络深度的增加，梯度消失或爆炸将发生。解决此问题的传统解决方案是数据预处理，例如归一化和规则化。尽管这些方法可以解决消失和爆炸的梯度问题，但它们会同时使网络退化。剩余网络可以解决梯度消失和爆炸的问题，同时提高网络性能。因此，它被广泛使用。

注意机制在 [444-35] 中引入。它通过根据原始特征图的重要性赋予其权重来提高特征表达能力。[36] 中引入了剩余注意机制，它是通过增加剩余网络结构中的注意机制来实现的。它可以分为两部分，如图2所示，第一部分是剩余网络的中继分支，第二部分是软掩码分支。在对输入特征进行下采样和上采样之后，由激活函数形成软掩码分支。将树干分支和软遮罩分支组合在一起，使用公式形成剩余注意力机制。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1666939565683.png" alt="1666939565683" style="zoom:80%;" />

其中H(x) 是输出特征，x是原始特征。V是卷积运算，M是软蒙版的注意参数。这种方法称为残差注意力机制。

剩余注意力网络具有收敛速度快、无梯度消失或无梯度爆炸、无退化和良好的特征表达能力的优点。因此，它被用于许多领域，例如超分辨率 [37,38]，序列学习 [39] 等。

#### 2.2 金字塔注意机制 

如图3所示。本文以注意力机制和金字塔结构为亮点，取得了比对比算法更好的分割精度和效果。特征金字塔注意是对特征金字塔的改进。它在传统的特征金字塔模型上增加了遮罩模块，使输出特征具有多尺度和注意力优势。因此，它被广泛用于图像分割 [41]，显着性检测 [42,43] 和动作分类 [44]。金字塔注意机制可以表示为等式。(2)。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1666940135172.png" alt="1666940135172" style="zoom:80%;" />

其中 H(x) 是输出特征，x 是原始特征。 V是卷积运算。 P1、P2、P3是金字塔网络三层的各自参数。这种方法称为金字塔注意力机制。

#### 2.4MARPAN

残差注意力和金字塔注意力机制虽然各有千秋，但也有其不足之处。例如，残余注意力不能提取深度特征。金字塔注意力可以提取深层特征，但是随着层数的增加，很容易丢失原始信息。因此，我们的动机是将残差注意力和金字塔注意力机制结合在一起，形成一个称为MSRPAN的新网络，如图4所示。MSRPAN可以表示为Eq。(3)。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1666940890167.png" alt="1666940890167" style="zoom:80%;" />

其中H(x) 是输出特征，x是原始特征。V是卷积运算，M是软蒙版的注意参数。P1、P2和P3是金字塔网络三层的各自参数。我们将这种方法称为MSRPAN learning。从Eq可以看出。(3)，MSRPAN比等式中的剩余注意力机制多了一个项目P1(P2(P3(x)。(1)，增加多尺度信息。此外，MSRPAN比公式中的金字塔注意机制多了一个项目M(x)。(2)，增强了提取的特征。MSRPAN同时结合了剩余注意力和金字塔注意力机制的优点。因此，MSRPAN可以提取比单一的剩余注意力或金字塔注意力机制更多的信息。毫无疑问，MSRPAN具有更好的特征提取和表达能力。

### 三.提出的算法

我们的融合算法由特征提取器，定影器和重构器组成。我们算法中的每个模块都是按顺序引入的。所提出的算法的示意图如图5所示。我们的算法分为三个部分，即特征提取器，定影器和重构器。特征提取器用于提取原始图像中的高维特征，并利用特征定影器将这些提取的特征融合。然后，由重建器将融合的特征重建到融合的图像中。尽管我们的算法中存在特征重构器，但是在特征重构过程之前有一个特征融合过程。特征重构器的功能是将融合的特征解码为融合图像。此外，我们算法的目的和结果是获得融合图像。因此，我们提出的算法是一种融合算法。

特征提取器由三个MSRPAN块组成，重构器由三个卷积层组成。MSRPAN块的数量由第4节中的实验确定。所提出算法的步骤如算法1所示。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1666941665698.png" alt="1666941665698" style="zoom:80%;" />

#### 3.1MSRPAN模块

 MSRPAN结构如图4所示，MSRPAN的优点如下。1) 我们使用不同的尺度来提取金字塔中的特征。在每一层中，我们使用三个卷积尺度来获得多尺度特征。2) 我们在金字塔注意模块中添加了剩余注意机制。因此，随着特征表达能力的增加，梯度不会消失或爆炸。 

输入原始图像时，应用1 × 1卷积滤波器获得64维特征图。通过池化获得尺寸分别为原始的1/2、1/4和1/8倍的三个特征图。每一层都由3 × 3、5 × 5和7 × 7滤波器卷积，以获得多尺度特征。然后，我们把它们加在一起。之后，我们使用剩余注意力机制来获取每一层中的输出特征。接下来，我们对输出特征进行上采样，并使用该方法获得输出特征，直到到达第一层。最后，我们使用剩余注意力机制来获得最后一个特征。

尽管使用大的卷积滤波器可以直接获得大的接收场，但它将导致大量的计算和参数。为了解决这个问题，VGGNet [45] 首先使用了几个串联的小型卷积滤波器来代替大型卷积滤波器。在相同的感受野下，网络参数的数量大大减少。因此，我们用两个3 × 3卷积滤波器代替一个5 × 5滤波器，用三个3 × 3卷积滤波器代替一个7 × 7滤波器，可以大大减少参数数量，同时达到相同的效果。

#### 3.2特征提取

如图所示，特征提取由两部分组成，第一部分是维数增加模块，由残差注意力机制和一个1×1滤波器组成，输入通道为1维，输出通道为64维。第二部分是特征提取模块，由三个 MSRPAN 块和残差注意机制组成。残差注意力机制的目的是提高训练速度和特征表达能力。

#### 3.3特征融合

特征融合器用于融合提取的特征。如图7所示。在下面的内容中，我们介绍了常用的策略和提出的策略。

* 加法策略

  * 添加策略是最常用的特征融合方法之一，如图8（a）所示。其公式表示如下。

    <img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1666942742947.png" alt="1666942742947" style="zoom:80%;" />

    其中F是融合特征。F1和F2分别是图像1和2的提取特征。

* 平均策略

  * 平均策略是另一种常用的特征融合方法，如图8(b) 所示。其公式表示如下。

    <center>F = (F1 + F2)/2</center>

    其中F是融合特征。F1和F2分别是提取的原始图像1和2的特征图。

* 特征能量比策略

  * 加法和平均策略没有考虑特征权重。因此，我们提出了特征能量比策略 (FER)，如图8(c) 所示。它的优势在第4节中得到了验证。FER策略的定义如下。

    <center>F = k1 ∗ F1 + k2 ∗ F2</center>

    其中k1，k2是融合系数。k1 = F2 1/(F2 1 F2 2)，k2 = F2 F2 (6) 2/(F2 1 2)。F是融合的特征。F1和F2分别是提取的图像1和2的特征图。

#### 3.4功能重构器

特征重构器用于从融合的特征中获取融合的图像。如图9所示。特征重构器的目的是减小尺寸。首先，我们使用一个3 × 3滤波器进行卷积运算，输入和输出通道为64维。然后，我们使用一个3 × 3滤波器进行卷积运算，输入通道为64维，输出通道为32维。最后，我们使用1 × 1滤波器进行卷积运算，输入通道为32维，输出通道为1维。因此，我们可以在最后获得以1维的通道作为输出的亮度图像。

#### 3.5损失函数

均方误差 (MSE) 损失函数简单，速度快，效果好。在我们的论文中，MSE被用作训练过程中的损失函数，以减少生成的图像与原始图像之间的误差。MSE的定义如下。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1666945026477.png" alt="1666945026477" style="zoom:80%;" />

其中I是原始图像，R是融合图像。M和N分别是图像中的行数和列数。

### 四.实验和讨论

本部分包括融合指标，融合策略选择，MSRPAN块的选择以及算法比较。通过实验选择融合策略和MSRPAN块。然后，将所提出算法的融合结果与参考算法的融合结果进行了比较。

#### 4.1融合度量

大量的融合度量已经被提出。但是，单个度量只能反映某种特征。因此，我们需要不同的度量来评估融合图像。结构相似性 (SSIM) [46] 是用于测量两个图像的结构相似性的一种度量。它的值是亮度，对比度和结构三个不同因素的组合。均值用于估计亮度。标准差用于估计对比度，协方差用于测量结构相似性。SSIM范围的范围是 [0,1]。SSIM越大，图像失真越小。SSIM的定义如下。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1666945575650.png" alt="1666945575650" style="zoom:80%;" />

其中 μx 和 μf 分别是图像 X 和 F 的均值。 σx 和 σf 分别是图像 X 和 F 的方差。 σxf 是图像 X 和 F 的协方差。C1、C2 和 C3 是常数。为了避免分母接近0的情况，我们通常设C1 = (K1 × L)2 C2 = (K2 × L)2, C3 = C2/2, K1 = 0.01, K2 = 0.03, 和L = 255。互信息（MI）[47]描述了图像对的图像强度分布的相似性。 MI 越大，两幅图像越相似。 MI定义如下。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\1666945828033.png" alt="1666945828033" style="zoom:80%;" />